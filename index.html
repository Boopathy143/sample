<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sample Control System</title>

<style>
*{box-sizing:border-box;}
body{margin:0;font-family:Segoe UI;background:#f4f6fa;}
header{background:#1e293b;color:white;padding:12px;text-align:center;font-weight:bold;}
.container{padding:12px;}
.card{background:white;padding:14px;border-radius:10px;margin-bottom:14px;box-shadow:0 3px 8px rgba(0,0,0,0.1);}
input,select{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc;}
button{padding:8px;border:none;border-radius:6px;background:#2563eb;color:white;font-weight:bold;margin-top:4px;cursor:pointer;}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;}
.rack{padding:10px;text-align:center;border-radius:8px;font-size:12px;font-weight:bold;}
.active{background:#16a34a;color:white;}
.empty{background:#e5e7eb;}
.small-text{font-size:11px;font-weight:normal;}
.search-result{font-size:13px;border-bottom:1px solid #eee;padding:8px 0;}
.summary-box{font-size:15px;line-height:1.8;}
.summary-total{font-size:18px;font-weight:bold;padding:10px;border-radius:8px;margin-bottom:8px;}
.active-box{background:#dcfce7;color:#166534;}
.scrap-box{background:#fee2e2;color:#991b1b;}
.brand-line{display:flex;justify-content:space-between;font-size:16px;padding:6px 0;border-bottom:1px solid #f1f1f1;}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>

<header>SAMPLE CONTROL SYSTEM</header>

<div class="container">

<div class="card">
<h3>Add Sample</h3>

<select id="rack"></select>
<input type="text" id="lot" placeholder="Lot Number">

<select id="brand">
<option value="">Select Brand</option>
<option>OOM ADVANCE</option>
<option>NIHAR ADVANCE</option>
<option>OOM GOLD</option>
<option>NIHAR GOLD</option>
<option>PARACHUTE</option>
</select>

<input type="text" id="pmcode" placeholder="PM Code">

<select id="sku">
<option value="">Select SKU</option>
<option value="35ft">35ft</option>
<option value="60ft">60ft</option>
<option value="90ft">90ft</option>
<option value="160ft">160ft</option>
<option value="450ft">450ft</option>
<option value="500ft">500ft</option>
</select>

<input type="number" id="bottles" placeholder="Bottle Count">
<input type="date" id="sampleDate">

<button onclick="addSample()">Submit</button>
</div>

<div class="card">
<h3>Oil Summary</h3>
<button onclick="exportExcel()">Download Excel Report</button>
<button onclick="downloadPDF()">Download Oil Summary PDF</button>
<br><br>
<div id="oilSummary" class="summary-box"></div>
</div>

<div class="card">
<h3>Search (Lot / Brand / PM Code / Date)</h3>
<input type="text" id="searchInput" onkeyup="searchData()">
<div id="searchResult"></div>
</div>

<div class="card">
<h3>Rack Dashboard</h3>
<div class="grid" id="rackGrid"></div>
</div>

</div>

<script>

const WEB_APP_URL="https://script.google.com/macros/s/AKfycbxgk0vQg47NjKkCRGh-xPeer_2yaAjHyH9S2hr2IxMCArEsxku5d3wXjB1OwIaULa0i/exec";

let data=[];

const weightMaster={
"OOM ADVANCE":{"35ft":29,"60ft":58,"90ft":88,"160ft":155,"450ft":440,"500ft":490},
"NIHAR ADVANCE":{"35ft":29,"60ft":58,"90ft":88,"160ft":155,"450ft":440,"500ft":490},
"OOM GOLD":{"35ft":29,"60ft":58,"90ft":88,"160ft":155,"450ft":440,"500ft":490},
"NIHAR GOLD":{"35ft":29,"60ft":58,"90ft":88,"160ft":155,"450ft":440,"500ft":490},
"PARACHUTE":{"35ft":29,"60ft":58,"90ft":88,"160ft":155,"450ft":440,"500ft":490}
};

const rackSelect=document.getElementById("rack");
for(let i=1;i<=135;i++){
 let opt=document.createElement("option");
 opt.value=i;
 opt.text="Rack "+i;
 rackSelect.appendChild(opt);
}

document.getElementById("sku").addEventListener("change",function(){
 let sku=this.value;
 let bottlesInput=document.getElementById("bottles");
 if(["35ft","60ft","90ft","160ft"].includes(sku)) bottlesInput.value=8;
 if(["450ft","500ft"].includes(sku)) bottlesInput.value=5;
});

async function loadData(){
 const res=await fetch(WEB_APP_URL);
 data=await res.json();
 renderRack();
 calculateSummary();
}

async function postData(payload){
 await fetch(WEB_APP_URL,{
  method:"POST",
  body:JSON.stringify(payload)
 });
}

async function addSample(){
 let rack=document.getElementById("rack").value;
 let lot=document.getElementById("lot").value;
 let brand=document.getElementById("brand").value;
 let pmcode=document.getElementById("pmcode").value;
 let sku=document.getElementById("sku").value;
 let bottles=document.getElementById("bottles").value;
 let sampleDateInput=document.getElementById("sampleDate").value;

 if(!rack||!lot||!brand||!pmcode||!sku||!bottles||!sampleDateInput){
   alert("Fill all fields");
   return;
 }

 let sampleDate=new Date(sampleDateInput);
 let expiry=new Date(sampleDate);
 expiry.setMonth(expiry.getMonth()+21);

 await postData({
  action:"add",
  id:Date.now(),
  rack,lot,brand,pmcode,sku,bottles,
  sampleDate:sampleDate.toISOString(),
  expiry:expiry.toISOString(),
  status:"ACTIVE"
 });

 await loadData();
 alert("Saved Successfully");
}

async function scrap(id){
 await postData({action:"scrap",id});
 await loadData();
 searchData();
}

async function deleteEntry(id){
 await postData({action:"delete",id});
 await loadData();
 searchData();
}

function calculateSummary(){
 let activeBrandTotals={},scrapBrandTotals={},activeKg=0,scrapKg=0;

 data.forEach(d=>{
  if(!weightMaster[d.brand]||!weightMaster[d.brand][d.sku])return;
  let kg=(parseFloat(d.bottles)*weightMaster[d.brand][d.sku])/1000;
  if(d.status==="SCRAPPED"){
    scrapKg+=kg;
    if(!scrapBrandTotals[d.brand])scrapBrandTotals[d.brand]=0;
    scrapBrandTotals[d.brand]+=kg;
  }else{
    activeKg+=kg;
    if(!activeBrandTotals[d.brand])activeBrandTotals[d.brand]=0;
    activeBrandTotals[d.brand]+=kg;
  }
 });

 let html="";
 html+=`<div class="summary-total active-box">Total Active Oil : ${activeKg.toFixed(3)} KG</div>`;
 Object.keys(activeBrandTotals).forEach(b=>{
  html+=`<div class="brand-line"><span>${b}</span><span>${activeBrandTotals[b].toFixed(3)} KG</span></div>`;
 });
 html+="<br>";
 html+=`<div class="summary-total scrap-box">Total Scrap Oil : ${scrapKg.toFixed(3)} KG</div>`;
 Object.keys(scrapBrandTotals).forEach(b=>{
  html+=`<div class="brand-line"><span>${b}</span><span>${scrapBrandTotals[b].toFixed(3)} KG</span></div>`;
 });

 document.getElementById("oilSummary").innerHTML=html;
}

function exportExcel(){
 let activeBrandTotals={},scrapBrandTotals={};

 data.forEach(d=>{
  if(!weightMaster[d.brand]||!weightMaster[d.brand][d.sku])return;
  let kg=(parseFloat(d.bottles)*weightMaster[d.brand][d.sku])/1000;
  if(d.status==="SCRAPPED"){
    if(!scrapBrandTotals[d.brand])scrapBrandTotals[d.brand]=0;
    scrapBrandTotals[d.brand]+=kg;
  }else{
    if(!activeBrandTotals[d.brand])activeBrandTotals[d.brand]=0;
    activeBrandTotals[d.brand]+=kg;
  }
 });

 let csv="Brand,Active KG,Scrap KG\n";
 let brands=new Set([...Object.keys(activeBrandTotals),...Object.keys(scrapBrandTotals)]);
 brands.forEach(b=>{
  csv+=`${b},${(activeBrandTotals[b]||0).toFixed(3)},${(scrapBrandTotals[b]||0).toFixed(3)}\n`;
 });

 let blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
 let url=URL.createObjectURL(blob);
 let link=document.createElement("a");
 link.href=url;
 link.download="Brand_Oil_Report.csv";
 document.body.appendChild(link);
 link.click();
 document.body.removeChild(link);
}

function downloadPDF(){

 let original = document.getElementById("oilSummary");

 if(!original || original.innerHTML.trim()===""){
   alert("Oil Summary Empty");
   return;
 }

 // Create clean wrapper
 let wrapper = document.createElement("div");
 wrapper.style.padding = "20px";
 wrapper.style.background = "#ffffff";
 wrapper.style.color = "#000";
 wrapper.style.width = "800px";   // fixed width for proper render

 wrapper.innerHTML = `
   <h2 style="text-align:center;margin-bottom:20px;">
     Oil Summary Report
   </h2>
   ${original.innerHTML}
 `;

 document.body.appendChild(wrapper);

 let opt = {
   margin: 10,
   filename: 'Oil_Summary_Report.pdf',
   html2canvas: {
     scale: 2,
     useCORS: true
   },
   jsPDF: {
     unit: 'mm',
     format: 'a4',
     orientation: 'portrait'
   }
 };

 html2pdf().set(opt).from(wrapper).save().then(()=>{
   document.body.removeChild(wrapper);
 });

}
function renderRack(){
 let grid=document.getElementById("rackGrid");
 grid.innerHTML="";
 for(let i=1;i<=135;i++){
  let rackData=data.filter(d=>parseInt(d.rack)===i&&d.status!=="SCRAPPED");
  let div=document.createElement("div");
  div.classList.add("rack");
  if(rackData.length===0){
    div.classList.add("empty");
    div.innerHTML="Rack "+i+"<br><span class='small-text'>Empty</span>";
  }else{
    div.classList.add("active");
    div.innerHTML="Rack "+i+"<br><span class='small-text'>"+rackData.length+" Lots</span>";
  }
  grid.appendChild(div);
 }
}

function searchData(){
 let input=document.getElementById("searchInput").value.toLowerCase().trim();
 let result=document.getElementById("searchResult");
 result.innerHTML="";
 if(input===""){renderRack();return;}
 let filtered=data.filter(d=>{
  let formattedDate=new Date(d.sampleDate).toLocaleDateString("en-GB");
  return d.lot.toLowerCase().includes(input)||
         d.brand.toLowerCase().includes(input)||
         d.pmcode.toLowerCase().includes(input)||
         formattedDate.includes(input);
 });
 filtered.forEach(d=>{
  let formattedDate=new Date(d.sampleDate).toLocaleDateString("en-GB");
  let statusColor=d.status==="SCRAPPED"?"red":"green";
  let div=document.createElement("div");
  div.classList.add("search-result");
  div.innerHTML=
   `<b>Lot:</b> ${d.lot} |
    <b>Brand:</b> ${d.brand} |
    <b>Rack:</b> ${d.rack} |
    <b>Date:</b> ${formattedDate} |
    <b style="color:${statusColor}">${d.status}</b>
    <br>
    ${d.status!=="SCRAPPED"?`<button onclick="scrap(${d.id})" style="background:#f59e0b">Scrap</button>`:""}
    <button onclick="deleteEntry(${d.id})" style="background:#dc2626">Delete</button>`;
  result.appendChild(div);
 });
}

loadData();

</script>
</body>
</html>
